

  clickHandler: function (event) {
    log.fine("User selected '" + event.data.name + " / " + event.data.type + "'");

    if (event.data.type == dashboard.clickHandlerTypes.selectWorkspace) {
      // Re-Initialize Dashboard
      dashboard.hideAffordancesBar();
      dashboard.hideArtifactsBar();
      dashboard.hideContentContainer();
      dashboard.currentArtifacts = {};

      yggdrasilInterface.fetchArtifactsInWorkspace(event.data.name, dashboard.fetchArtifactsCallback);
    } else if (event.data.type == dashboard.clickHandlerTypes.selectArtifact) {
      currentArtifactUri = event.data.name;
      dashboard.updateAffordancesBar(event.data.name);
    } else if (event.data.type == dashboard.clickHandlerTypes.followAffordance) {
      currentAffordanceId = event.data.name;
      dashboard.followAffordance(currentAffordanceId);
    } else {
      log.error("##### UNHANDLED EVENT: " + event.data.type);
    }
  },


  hideArtifactsBar: function () {
    dashboard.$artifactsScrollContainer.hide();
  },

  updateArtifactsBar: function (doAnimate) {
    var currentArtifacts = dashboard.currentArtifacts;

    log.fine('Updating inspector with information on all ' + Object.keys(currentArtifacts).length + ' artifacts.');

    // Count affordances to simplify handlebar's life
    for (const [currentArtifactUri, currentArtifactInformation] of Object.entries(currentArtifacts)) {
      currentArtifacts[currentArtifactUri]['numAffordances'] = Object.keys(currentArtifacts[currentArtifactUri].affordances).length;
    }

    // Hand over to handlebars
    log.fineSeparate('All Artifacts To Handlebars', currentArtifacts);
    var $artifactsContent = Handlebars.templates.artifactsList({ currentArtifacts: currentArtifacts, animate: true });
    dashboard.$artifactsScrollContainer.empty().show().append($artifactsContent);

    dashboard.addClickHandlersToCurrentArtifacts(currentArtifacts);
  },

  hideAffordancesBar: function () {
    dashboard.$affordancesScrollContainer.hide();
  },

  updateAffordancesBar: function (currentArtifactUri) {
    artifactRdfStore = dashboard.currentArtifacts[currentArtifactUri].rdfStore;
    artifactAffordances = dashboard.currentArtifacts[currentArtifactUri].affordances;
    log.fine('Updating inspector with information on ' + Object.keys(artifactAffordances).length + ' affordances of ' + dashboard.currentArtifacts[currentArtifactUri].title);

    // Empty affordances in blockly
    blocklyManager.resetAffordancesCategory();

    // Extend affordances descriptor with input schema. Do the graph walking here to simplify the templates
    for (const affordanceTitle in artifactAffordances) {
      affordanceNode = artifactAffordances[affordanceTitle].affordanceNode;

      log.fine('Requesting: ' + affordanceNode)
      affordanceHasInputSchema = td.hasInputSchema(affordanceNode, artifactRdfStore);
      artifactAffordances[affordanceNode.value]['hasInputSchema'] = affordanceHasInputSchema;

      if (affordanceHasInputSchema) {
        affordanceInputSchema = td.getInputSchema(affordanceNode, artifactRdfStore);
        log.fineSeparate(affordanceTitle, affordanceHasInputSchema);
        artifactAffordances[affordanceNode.value]['inputSchema'] = affordanceInputSchema;
      }

      // Generate Blockly Block for Affordance
      blocklyManager.generateAndAddAffordanceBlock(artifactAffordances[affordanceTitle]);
    }

    // Update global affordances information
    dashboard.currentAffordances = artifactAffordances;
    currentAffordanceIds = Object.keys(artifactAffordances);

    // Hand over to handlebars
    log.debugSeparate('All Affordances to Handlebars', artifactAffordances);
    var $affordancesContent = Handlebars.templates.affordancesList({ currentAffordances: artifactAffordances, animate: true });
    dashboard.$affordancesScrollContainer.empty().show().append($affordancesContent);

    dashboard.addClickHandlersToCurrentAffordances(currentAffordanceIds);
  },

  followAffordance: function (affordanceId) {
    log.fine('Following ' + affordanceId);
    affordanceInformation = dashboard.currentAffordances[affordanceId]
    artifactInformation = dashboard.currentArtifacts[affordanceInformation['affordanceArtifact']]

    log.fineSeparate('Affordance Information', affordanceInformation);
    log.fineSeparate('Artifact Information', artifactInformation);

    // Assemble input data according to request
    // This part should definitely be done using node-wot; however, this needs to be synchronized with wot-td (i.e., yggdrasil needs to provide json TDs that node-wot can parse)
    if (affordanceInformation.hasInputSchema) {
      log.error('Requests with input schemas are not fully implemented yet');

      inputData = {};

      $("div[id='" + affordanceId + "']").find("input").each(function(index) {
        log.debug( index + ": " + $(this).attr('id') + ' --- ' + $(this).val() );
        inputData[$(this).attr('id')] = $(this).val();
      })

      log.debugSeparate('Input', inputData);

      affordanceResponse = td.followAffordance(affordanceInformation['affordanceNode'], artifactInformation.rdfStore, inputData, dashboard.actOnAffordanceResultCallback);
      log.debugSeparate('Received Response', affordanceResponse);
    } else {
      inputData = null;

      log.debugSeparate('Input', inputData);
      log.debugSeparate('Callback', dashboard.actOnAffordanceResultCallback);

      affordanceResponse = td.followAffordance(affordanceInformation['affordanceNode'], artifactInformation.rdfStore, inputData, dashboard.actOnAffordanceResultCallback);
      log.debugSeparate('Received Response', affordanceResponse);
    }
  },

  actOnAffordanceResultCallback: function (message) {
    log.debugSeparate('Response to Handlebars', message);
    var $responseContent = Handlebars.templates.responseContent({ responseString: JSON.stringify(message), animate: true });
    dashboard.$responsesContainer.empty().show().append($responseContent);
  },

  hideContentContainer: function () {
    dashboard.$responsesContainer.hide();
  },

  /* Yggdrasil Interface Callbacks */

  fetchAffordancesCallback: function (artifactsInformation, animateArtifacts) {

    if (artifactsInformation.affordances == undefined) {
      log.debug('Artifact ' + artifactsInformation.uri + ' does not provide any affordances.');
    } else {
      log.debug('Fetched ' + Object.keys(artifactsInformation.affordances).length + ' affordances for artifact.');
    }

    artifactUri = artifactsInformation.uri;

    // Update global artifacts/affordances list
    if (dashboard.currentArtifacts.hasOwnProperty(artifactUri)) {
      log.debug('Artifact ' + artifactUri + ' already exists - updating affordances!');
    }

    dashboard.currentArtifacts[artifactUri] = artifactsInformation;

    log.fine('Current Artifacts Map');
    log.fine(dashboard.currentArtifacts);

    dashboard.updateArtifactsBar(animateArtifacts);
  },

  /** Utilities **/

  revealDashboard: function () {
    window.setTimeout(function () {
      dashboard.$loading.fadeOut(200);
      dashboard.$container.fadeIn(200);
      dashboard.$headerOptionsContainer.removeClass("hidden");
      dashboard.$headerOptionsContainer.addClass("centered-element");

      blocklyManager.init();

    }, 2000);
  },

  addClickHandlersToCurrentArtifacts: function (currentArtifacts) {
    currentArtifactUris = Object.keys(currentArtifacts);
    numArtifacts = currentArtifactUris.length;

    // Add click handlers to module links
    for (var i = 0; i < numArtifacts; i++) {
      currentArtifact = currentArtifactUris[i];
      log.debug("Attaching click handler to " + currentArtifact);
      $("div[id='" + currentArtifact + "']").click({ name: currentArtifact, type: dashboard.clickHandlerTypes.selectArtifact }, dashboard.clickHandler);
    }
  },

  addClickHandlersToCurrentAffordances: function (currentAffordanceIds) {
    numAffordances = currentAffordanceIds.length;

    // Add click handlers to module links
    for (var i = 0; i < numAffordances; i++) {
      var currentAffordance = currentAffordanceIds[i]
      log.debug("Attaching click handler to " + currentAffordance)
      $("div[id='" + currentAffordance + "']").find("div[id=follow-affordance-button]").click({ name: currentAffordance, type: dashboard.clickHandlerTypes.followAffordance }, dashboard.clickHandler);
    }
  },

  highlightSelected: function () {
    log.debug("Trigger: " + dashboard.currentTestModuleType)
    $("[element=testingModuleType]").each(function() {
      if ($(this).attr('id') === dashboard.currentTestModuleType) $(this).addClass("highlightBold")
      else $(this).removeClass("highlightBold")
    })
  },

  scrollAllListsToTop: function() {
    $('body, html, #artifacts-scroll-container').scrollTop(0);
    $('body, html, #affordances-scroll-container').scrollTop(0);
  },

  getFormattedDate: function () {
    var d = new Date();
    d = d.getFullYear() + "-" + ('0' + (d.getMonth() + 1)).slice(-2) + "-" + ('0' + d.getDate()).slice(-2) + "T" + ('0' + d.getHours()).slice(-2) + ":" + ('0' + d.getMinutes()).slice(-2) + ":" + ('0' + d.getSeconds()).slice(-2);
    return d;
  },

  uuidv4: function () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  },

  copy: function(that){
    var inp = document.createElement('input');
    document.body.appendChild(inp)
    inp.value = encodeURIComponent(that.textContent)
    inp.select();
    document.execCommand('copy', false);
    inp.remove();
  }
}
